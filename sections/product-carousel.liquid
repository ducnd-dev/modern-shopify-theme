{{ 'section-product-carousel.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}

<section class="product-carousel bg-neutral-50 dark:bg-neutral-800 section-{{ section.id }}-padding">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Section Header -->
    <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between mb-8">
      <div class="mb-4 sm:mb-0">
        {%- if section.settings.badge_text != blank -%}
          <span class="inline-block px-4 py-2 bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300 text-sm font-medium rounded-full mb-4">
            {{ section.settings.badge_text }}
          </span>
        {%- endif -%}
        
        {%- if section.settings.heading != blank -%}
          <h2 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-neutral-900 dark:text-neutral-100 mb-4 font-display">
            {{ section.settings.heading }}
          </h2>
        {%- endif -%}
        
        {%- if section.settings.description != blank -%}
          <p class="text-lg text-neutral-600 dark:text-neutral-400 max-w-2xl">
            {{ section.settings.description }}
          </p>
        {%- endif -%}
      </div>

      <!-- Navigation Controls -->
      <div class="flex items-center gap-4">
        <button 
          class="carousel-prev w-12 h-12 rounded-full bg-white dark:bg-neutral-700 border border-neutral-200 dark:border-neutral-600 flex items-center justify-center transition-all duration-300 hover:bg-primary-600 hover:border-primary-600 hover:text-white focus:outline-none focus:ring-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed"
          aria-label="Previous products"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
        
        <button 
          class="carousel-next w-12 h-12 rounded-full bg-white dark:bg-neutral-700 border border-neutral-200 dark:border-neutral-600 flex items-center justify-center transition-all duration-300 hover:bg-primary-600 hover:border-primary-600 hover:text-white focus:outline-none focus:ring-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed"
          aria-label="Next products"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
        
        {%- if section.settings.button_label != blank -%}
          <a 
            href="{{ section.settings.button_link | default: '#' }}" 
            class="hidden sm:inline-flex items-center px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white font-semibold rounded-full transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-primary-500/50"
          >
            {{ section.settings.button_label }}
            <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
            </svg>
          </a>
        {%- endif -%}
      </div>
    </div>

    <!-- Carousel Container -->
    <div class="relative overflow-hidden" data-carousel-container>
      <div class="carousel-track flex transition-transform duration-500 ease-in-out" data-carousel-track>
        {%- liquid
          assign collection_to_show = section.settings.collection
          if collection_to_show == blank
            assign collection_to_show = collections['all']
          endif
          
          assign products_to_show = section.settings.products_to_show | default: 12
        -%}

        {%- for product in collection_to_show.products limit: products_to_show -%}
          <div class="carousel-slide flex-none w-full sm:w-1/2 lg:w-1/3 xl:w-1/4 px-3">
            {% render 'product-card-beautiful',
              product_card_product: product,
              media_aspect_ratio: 1.0,
              show_secondary_image: section.settings.show_second_image,
              show_vendor: section.settings.show_vendor,
              show_rating: section.settings.show_rating
            %}
          </div>
        {%- endfor -%}
      </div>
    </div>

    <!-- Dots Indicator -->
    {%- if section.settings.show_dots -%}
      <div class="flex justify-center mt-8 gap-2" data-carousel-dots>
        <!-- Dots will be generated by JavaScript -->
      </div>
    {%- endif -%}

    <!-- Mobile View All Button -->
    {%- if section.settings.button_label != blank -%}
      <div class="text-center mt-8 sm:hidden">
        <a 
          href="{{ section.settings.button_link | default: '#' }}" 
          class="inline-flex items-center px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white font-semibold rounded-full transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-primary-500/50"
        >
          {{ section.settings.button_label }}
          <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
          </svg>
        </a>
      </div>
    {%- endif -%}
  </div>
</section>

<script>
  class ProductCarousel {
    constructor(element) {
      this.container = element;
      this.track = element.querySelector('[data-carousel-track]');
      this.slides = element.querySelectorAll('.carousel-slide');
      this.prevBtn = element.querySelector('.carousel-prev');
      this.nextBtn = element.querySelector('.carousel-next');
      this.dotsContainer = element.querySelector('[data-carousel-dots]');
      
      this.currentIndex = 0;
      this.slidesToShow = this.getSlidesToShow();
      this.totalSlides = this.slides.length;
      this.maxIndex = Math.max(0, this.totalSlides - this.slidesToShow);
      
      this.init();
    }
    
    init() {
      this.setupEventListeners();
      this.createDots();
      this.updateCarousel();
      this.setupTouchEvents();
      
      // Auto-resize on window resize
      window.addEventListener('resize', () => {
        this.slidesToShow = this.getSlidesToShow();
        this.maxIndex = Math.max(0, this.totalSlides - this.slidesToShow);
        this.currentIndex = Math.min(this.currentIndex, this.maxIndex);
        this.updateCarousel();
        this.createDots();
      });
    }
    
    getSlidesToShow() {
      if (window.innerWidth >= 1280) return 4; // xl
      if (window.innerWidth >= 1024) return 3; // lg
      if (window.innerWidth >= 640) return 2;  // sm
      return 1; // mobile
    }
    
    setupEventListeners() {
      this.prevBtn?.addEventListener('click', () => this.prev());
      this.nextBtn?.addEventListener('click', () => this.next());
    }
    
    setupTouchEvents() {
      let startX = 0;
      let currentX = 0;
      let isDragging = false;
      
      this.track.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        isDragging = true;
      });
      
      this.track.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        currentX = e.touches[0].clientX;
        e.preventDefault();
      });
      
      this.track.addEventListener('touchend', () => {
        if (!isDragging) return;
        isDragging = false;
        
        const diff = startX - currentX;
        const threshold = 50;
        
        if (Math.abs(diff) > threshold) {
          if (diff > 0) {
            this.next();
          } else {
            this.prev();
          }
        }
      });
    }
    
    createDots() {
      if (!this.dotsContainer) return;
      
      this.dotsContainer.innerHTML = '';
      const dotsCount = this.maxIndex + 1;
      
      for (let i = 0; i < dotsCount; i++) {
        const dot = document.createElement('button');
        dot.className = 'w-2 h-2 rounded-full transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-primary-500';
        dot.addEventListener('click', () => this.goToSlide(i));
        this.dotsContainer.appendChild(dot);
      }
      
      this.updateDots();
    }
    
    updateDots() {
      if (!this.dotsContainer) return;
      
      const dots = this.dotsContainer.querySelectorAll('button');
      dots.forEach((dot, index) => {
        if (index === this.currentIndex) {
          dot.className = 'w-8 h-2 rounded-full bg-primary-600 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-primary-500';
        } else {
          dot.className = 'w-2 h-2 rounded-full bg-neutral-300 dark:bg-neutral-600 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-primary-500';
        }
      });
    }
    
    prev() {
      this.currentIndex = Math.max(0, this.currentIndex - 1);
      this.updateCarousel();
    }
    
    next() {
      this.currentIndex = Math.min(this.maxIndex, this.currentIndex + 1);
      this.updateCarousel();
    }
    
    goToSlide(index) {
      this.currentIndex = Math.max(0, Math.min(this.maxIndex, index));
      this.updateCarousel();
    }
    
    updateCarousel() {
      const slideWidth = 100 / this.slidesToShow;
      const translateX = -this.currentIndex * slideWidth;
      this.track.style.transform = `translateX(${translateX}%)`;
      
      // Update button states
      this.prevBtn.disabled = this.currentIndex === 0;
      this.nextBtn.disabled = this.currentIndex === this.maxIndex;
      
      this.updateDots();
    }
  }
  
  // Initialize all carousels
  document.addEventListener('DOMContentLoaded', function() {
    const carousels = document.querySelectorAll('[data-carousel-container]');
    carousels.forEach(carousel => new ProductCarousel(carousel));
  });
</script>

{% schema %}
{
  "name": "Product Carousel",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "badge_text",
      "label": "Badge text"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Trending Products"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection",
      "info": "Leave empty to show all products"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 4,
      "max": 50,
      "step": 2,
      "label": "Products to show",
      "default": 12
    },
    {
      "type": "header",
      "content": "Product card settings"
    },
    {
      "type": "checkbox",
      "id": "show_second_image",
      "label": "Show second image on hover",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "Show vendor",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "label": "Show product rating",
      "default": true
    },
    {
      "type": "header",
      "content": "Carousel settings"
    },
    {
      "type": "checkbox",
      "id": "show_dots",
      "label": "Show dot indicators",
      "default": true
    },
    {
      "type": "header",
      "content": "Button"
    },
    {
      "type": "text",
      "id": "button_label",
      "label": "Button label"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "Button link"
    },
    {
      "type": "header",
      "content": "Section padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "Product Carousel"
    }
  ]
}
{% endschema %}