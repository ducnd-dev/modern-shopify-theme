{% comment %}
  Newsletter popup modal
{% endcomment %}

{%- if settings.newsletter_popup_enabled -%}
  <div id="newsletter-modal" class="fixed inset-0 bg-black bg-opacity-50 z-100 hidden flex items-center justify-center p-4" role="dialog" aria-labelledby="newsletter-modal-title" aria-modal="true">
    <div class="bg-white dark:bg-neutral-800 rounded-lg shadow-xl max-w-md w-full mx-4 overflow-hidden">
      <div class="relative">
        <!-- Close button -->
        <button 
          type="button" 
          class="absolute top-4 right-4 text-neutral-400 hover:text-neutral-600 dark:hover:text-neutral-200 z-10"
          onclick="closeNewsletterModal()"
          aria-label="{{ 'accessibility.close' | t }}"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>

        <!-- Modal content -->
        <div class="p-8">
          <div class="text-center mb-6">
            <h2 id="newsletter-modal-title" class="text-2xl font-bold text-neutral-900 dark:text-neutral-100 mb-2">
              {{ settings.newsletter_popup_title | default: 'Stay in the loop' }}
            </h2>
            <p class="text-neutral-600 dark:text-neutral-300">
              {{ settings.newsletter_popup_text | default: 'Subscribe to our newsletter and be the first to know about new products and exclusive offers.' }}
            </p>
          </div>

          {% form 'customer', id: 'newsletter-popup-form', class: 'newsletter-form' %}
            {%- if form.posted_successfully? -%}
              <div class="text-center">
                <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4 mb-4">
                  <p class="text-green-800 dark:text-green-200">
                    {{ 'newsletter.success_message' | t | default: 'Thank you for subscribing!' }}
                  </p>
                </div>
                <button 
                  type="button" 
                  class="btn btn-primary w-full"
                  onclick="closeNewsletterModal()"
                >
                  {{ 'accessibility.close' | t | default: 'Close' }}
                </button>
              </div>
            {%- else -%}
              <div class="space-y-4">
                <div>
                  <label for="newsletter-popup-email" class="sr-only">{{ 'newsletter.label' | t }}</label>
                  <input
                    type="email"
                    name="contact[email]"
                    id="newsletter-popup-email"
                    class="w-full px-4 py-3 border border-neutral-300 dark:border-neutral-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent bg-white dark:bg-neutral-700 text-neutral-900 dark:text-neutral-100"
                    placeholder="{{ 'newsletter.placeholder' | t | default: 'Enter your email address' }}"
                    required
                    autocomplete="email"
                  >
                  <input type="hidden" name="contact[tags]" value="newsletter">
                </div>

                {%- if form.errors -%}
                  <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
                    {%- for field in form.errors -%}
                      <p class="text-red-800 dark:text-red-200 text-sm">
                        {{ form.errors.translated_fields[field] | capitalize }} {{ form.errors.messages[field] }}
                      </p>
                    {%- endfor -%}
                  </div>
                {%- endif -%}

                <button 
                  type="submit" 
                  class="btn btn-primary w-full"
                  aria-label="{{ 'newsletter.button_label' | t | default: 'Subscribe' }}"
                >
                  {{ 'newsletter.button_label' | t | default: 'Subscribe' }}
                </button>

                <div class="text-center">
                  <button 
                    type="button" 
                    class="text-sm text-neutral-500 hover:text-neutral-700 dark:hover:text-neutral-300 transition-colors"
                    onclick="dismissNewsletterModal()"
                  >
                    No thanks, don't show this again
                  </button>
                </div>
              </div>
            {%- endif -%}
          {% endform %}
        </div>
      </div>
    </div>
  </div>

  <script>
    // Newsletter modal functionality
    function closeNewsletterModal() {
      const modal = document.getElementById('newsletter-modal');
      if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
      }
    }

    function dismissNewsletterModal() {
      // Set a cookie/localStorage to not show again
      localStorage.setItem('newsletter-dismissed', 'true');
      closeNewsletterModal();
    }

    function showNewsletterModal() {
      const modal = document.getElementById('newsletter-modal');
      if (modal) {
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        
        // Focus on email input for accessibility
        const emailInput = document.getElementById('newsletter-popup-email');
        if (emailInput) {
          setTimeout(() => emailInput.focus(), 100);
        }
      }
    }

    // Auto-show modal after delay if not dismissed
    document.addEventListener('DOMContentLoaded', function() {
      const dismissed = localStorage.getItem('newsletter-dismissed');
      const delay = {{ settings.newsletter_popup_delay | default: 5000 }};
      
      if (!dismissed && delay > 0) {
        setTimeout(showNewsletterModal, delay);
      }
    });

    // Close modal when clicking outside
    document.getElementById('newsletter-modal')?.addEventListener('click', function(e) {
      if (e.target === this) {
        closeNewsletterModal();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeNewsletterModal();
      }
    });
  </script>
{%- endif -%}