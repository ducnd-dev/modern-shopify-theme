{% comment %}
  Enhanced Cart Drawer with Advanced Features
  - Quantity controls with +/- buttons
  - Remove with undo functionality
  - Discount codes
  - Shipping calculator
  - Cart notes
  - Recommended products
  - Progress bar for free shipping
{% endcomment %}

<!-- Cart Drawer Overlay -->
<div class="cart-drawer-overlay fixed inset-0 bg-black/50 backdrop-blur-sm z-50 opacity-0 invisible transition-all duration-300" id="cart-drawer-overlay"></div>

<!-- Cart Drawer -->
<div class="cart-drawer fixed top-0 right-0 w-full sm:w-[420px] h-full bg-white dark:bg-neutral-900 z-50 transform translate-x-full transition-transform duration-300 shadow-2xl" id="cart-drawer">
  <div class="flex flex-col h-full">
    
    <!-- Header -->
    <div class="cart-header flex items-center justify-between p-4 sm:p-6 border-b border-neutral-200 dark:border-neutral-700">
      <div class="header-info">
        <h2 class="text-lg sm:text-xl font-semibold text-neutral-900 dark:text-white">
          Shopping Cart
        </h2>
        <p class="text-sm text-neutral-500 dark:text-neutral-400 mt-1">
          <span id="cart-drawer-count">{{ cart.item_count }}</span> 
          {% if cart.item_count == 1 %}item{% else %}items{% endif %} in your cart
        </p>
      </div>
      <button
        class="close-cart p-2 rounded-lg text-neutral-700 dark:text-neutral-300 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-primary-600 dark:hover:text-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors duration-300"
        id="cart-drawer-close"
        aria-label="Close cart"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Free Shipping Progress Bar -->
    <div class="free-shipping-progress p-4 sm:p-6 bg-gradient-to-r from-primary-50 to-accent-50 dark:from-primary-900/20 dark:to-accent-900/20 border-b border-neutral-200 dark:border-neutral-700" id="shipping-progress">
      <div class="shipping-message text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2">
        <span id="shipping-text">Add $<span id="remaining-amount">50.00</span> more for free shipping!</span>
      </div>
      <div class="progress-bar bg-neutral-200 dark:bg-neutral-700 rounded-full h-2 overflow-hidden">
        <div class="progress-fill bg-gradient-to-r from-primary-500 to-accent-500 h-full rounded-full transition-all duration-500" id="shipping-progress-fill" style="width: 0%"></div>
      </div>
    </div>

    <!-- Cart Items Container -->
    <div class="cart-items-container flex-1 overflow-y-auto" id="cart-drawer-items">
      {%- if cart == empty -%}
        <!-- Empty Cart State -->
        <div class="empty-cart flex flex-col items-center justify-center h-full p-6 sm:p-8 text-center">
          <div class="empty-cart-icon mb-4">
            <svg class="w-16 h-16 text-neutral-300 dark:text-neutral-600 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-neutral-900 dark:text-white mb-2">Your cart is empty</h3>
          <p class="text-neutral-600 dark:text-neutral-400 mb-6 max-w-sm">Looks like you haven't added anything to your cart yet. Start shopping to fill it up!</p>
          <button 
            class="continue-shopping bg-primary-600 hover:bg-primary-700 text-white font-medium py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-neutral-900"
            id="continue-shopping"
          >
            Continue Shopping
          </button>
        </div>
      {%- else -%}
        <!-- Cart Items List -->
        <div class="cart-items p-4 sm:p-6 space-y-4">
          {%- for item in cart.items -%}
            <div class="cart-item group relative bg-neutral-50 dark:bg-neutral-800 rounded-xl p-4 transition-all duration-300 hover:shadow-md" data-item-id="{{ item.id }}" data-item-key="{{ item.key }}">
              <!-- Remove Button -->
              <button 
                class="remove-item absolute top-2 right-2 w-8 h-8 bg-red-500/80 hover:bg-red-500 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all duration-300 focus:outline-none focus:opacity-100 focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:focus:ring-offset-neutral-800"
                data-item-key="{{ item.key }}"
                aria-label="Remove {{ item.product.title }}"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>

              <div class="flex gap-4">
                <!-- Product Image -->
                <div class="item-image flex-shrink-0">
                  <a href="{{ item.product.url }}" class="block w-16 h-16 sm:w-20 sm:h-20 bg-neutral-100 dark:bg-neutral-700 rounded-lg overflow-hidden group-hover:shadow-md transition-shadow duration-300">
                    {%- if item.image -%}
                      <img 
                        src="{{ item.image | image_url: width: 80 }}" 
                        alt="{{ item.image.alt | escape }}"
                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                        loading="lazy"
                      >
                    {%- else -%}
                      <div class="w-full h-full flex items-center justify-center">
                        <svg class="w-8 h-8 text-neutral-400" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                        </svg>
                      </div>
                    {%- endif -%}
                  </a>
                </div>

                <!-- Product Info -->
                <div class="item-info flex-1 min-w-0">
                  <div class="item-details mb-3">
                    <h4 class="font-medium text-neutral-900 dark:text-white text-sm sm:text-base truncate">
                      <a href="{{ item.product.url }}" class="hover:text-primary-600 dark:hover:text-primary-400 transition-colors duration-300">
                        {{ item.product.title }}
                      </a>
                    </h4>
                    
                    {%- if item.product.vendor -%}
                      <p class="text-xs text-neutral-500 dark:text-neutral-400 mt-1">{{ item.product.vendor }}</p>
                    {%- endif -%}
                    
                    {%- unless item.variant.title == 'Default Title' -%}
                      <p class="text-xs text-neutral-600 dark:text-neutral-400 mt-1">{{ item.variant.title }}</p>
                    {%- endunless -%}
                  </div>

                  <!-- Quantity and Price -->
                  <div class="item-controls flex items-center justify-between">
                    <!-- Quantity Selector -->
                    <div class="quantity-selector flex items-center bg-white dark:bg-neutral-700 border border-neutral-200 dark:border-neutral-600 rounded-lg overflow-hidden">
                      <button 
                        type="button" 
                        class="quantity-decrease w-8 h-8 flex items-center justify-center text-neutral-600 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-600 transition-colors duration-300 focus:outline-none focus:bg-neutral-100 dark:focus:bg-neutral-600 disabled:opacity-50 disabled:cursor-not-allowed"
                        data-item-key="{{ item.key }}"
                        {% if item.quantity <= 1 %}disabled{% endif %}
                      >
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                        </svg>
                      </button>
                      
                      <input 
                        type="number" 
                        class="quantity-input w-10 h-8 text-center bg-transparent border-0 text-sm text-neutral-900 dark:text-white focus:outline-none focus:ring-0" 
                        value="{{ item.quantity }}" 
                        min="1" 
                        max="99"
                        data-item-key="{{ item.key }}"
                        readonly
                      >
                      
                      <button 
                        type="button" 
                        class="quantity-increase w-8 h-8 flex items-center justify-center text-neutral-600 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-600 transition-colors duration-300 focus:outline-none focus:bg-neutral-100 dark:focus:bg-neutral-600"
                        data-item-key="{{ item.key }}"
                      >
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                      </button>
                    </div>

                    <!-- Item Price -->
                    <div class="item-price text-right">
                      <div class="current-price font-semibold text-neutral-900 dark:text-white text-sm sm:text-base">
                        {{ item.final_line_price | money }}
                      </div>
                      {%- if item.original_line_price > item.final_line_price -%}
                        <div class="original-price text-xs text-neutral-500 dark:text-neutral-400 line-through">
                          {{ item.original_line_price | money }}
                        </div>
                      {%- endif -%}
                      {%- if item.quantity > 1 -%}
                        <div class="unit-price text-xs text-neutral-500 dark:text-neutral-400">
                          {{ item.final_price | money }} each
                        </div>
                      {%- endif -%}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {%- endfor -%}
        </div>
      {%- endif -%}
    </div>

    <!-- Cart Footer -->
    <div class="cart-footer bg-neutral-50 dark:bg-neutral-800 border-t border-neutral-200 dark:border-neutral-700">
      
      <!-- Discount Code Section -->
      <div class="discount-section p-4 sm:p-6 border-b border-neutral-200 dark:border-neutral-700">
        <div class="discount-toggle cursor-pointer flex items-center justify-between text-sm font-medium text-neutral-700 dark:text-neutral-300 hover:text-primary-600 dark:hover:text-primary-400 transition-colors duration-300" id="discount-toggle">
          <span class="flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
            </svg>
            Add discount code
          </span>
          <svg class="w-4 h-4 transition-transform duration-300" id="discount-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </div>
        
        <div class="discount-form hidden mt-3" id="discount-form">
          <div class="flex gap-2">
            <input 
              type="text" 
              class="discount-input flex-1 px-3 py-2 bg-white dark:bg-neutral-700 border border-neutral-200 dark:border-neutral-600 rounded-lg text-sm text-neutral-900 dark:text-white placeholder-neutral-500 dark:placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-300" 
              placeholder="Enter discount code"
              id="discount-code-input"
            >
            <button 
              type="button" 
              class="apply-discount bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-neutral-800 disabled:opacity-50 disabled:cursor-not-allowed"
              id="apply-discount-btn"
            >
              Apply
            </button>
          </div>
          <div class="discount-message mt-2 text-xs hidden" id="discount-message"></div>
        </div>

        <!-- Applied Discounts -->
        <div class="applied-discounts mt-3 space-y-2 hidden" id="applied-discounts">
          <!-- Discounts will be populated by JavaScript -->
        </div>
      </div>

      <!-- Cart Notes -->
      <div class="cart-notes p-4 sm:p-6 border-b border-neutral-200 dark:border-neutral-700">
        <div class="notes-toggle cursor-pointer flex items-center justify-between text-sm font-medium text-neutral-700 dark:text-neutral-300 hover:text-primary-600 dark:hover:text-primary-400 transition-colors duration-300" id="notes-toggle">
          <span class="flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            Add a note
          </span>
          <svg class="w-4 h-4 transition-transform duration-300" id="notes-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </div>
        
        <div class="notes-form hidden mt-3" id="notes-form">
          <textarea 
            class="cart-notes-input w-full px-3 py-2 bg-white dark:bg-neutral-700 border border-neutral-200 dark:border-neutral-600 rounded-lg text-sm text-neutral-900 dark:text-white placeholder-neutral-500 dark:placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-300 resize-none" 
            rows="3" 
            placeholder="Special instructions, delivery notes, etc."
            id="cart-notes-textarea"
          >{{ cart.note }}</textarea>
          <p class="text-xs text-neutral-500 dark:text-neutral-400 mt-1">Your notes will be included with your order</p>
        </div>
      </div>

      <!-- Cart Summary -->
      <div class="cart-summary p-4 sm:p-6">
        <!-- Subtotal -->
        <div class="summary-line flex justify-between items-center mb-2">
          <span class="text-neutral-700 dark:text-neutral-300">Subtotal</span>
          <span class="font-semibold text-neutral-900 dark:text-white" id="cart-subtotal">{{ cart.total_price | money }}</span>
        </div>

        <!-- Shipping -->
        <div class="summary-line flex justify-between items-center mb-2">
          <span class="text-neutral-700 dark:text-neutral-300">Shipping</span>
          <span class="text-sm text-neutral-500 dark:text-neutral-400">Calculated at checkout</span>
        </div>

        <!-- Total -->
        <div class="summary-total flex justify-between items-center pt-3 border-t border-neutral-200 dark:border-neutral-700 mb-4">
          <span class="text-lg font-semibold text-neutral-900 dark:text-white">Total</span>
          <span class="text-lg font-bold text-neutral-900 dark:text-white" id="cart-total">{{ cart.total_price | money }}</span>
        </div>

        <!-- Checkout Button -->
        <button 
          type="button" 
          class="checkout-btn w-full bg-primary-600 hover:bg-primary-700 disabled:bg-neutral-300 dark:disabled:bg-neutral-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-neutral-900 disabled:transform-none disabled:cursor-not-allowed"
          id="checkout-btn"
          {% if cart == empty %}disabled{% endif %}
        >
          <span class="checkout-text">
            {% if cart == empty %}
              Cart is Empty
            {% else %}
              Secure Checkout
            {% endif %}
          </span>
          <span class="checkout-loading hidden">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Processing...
          </span>
        </button>

        <!-- Security Badge -->
        <div class="security-badge flex items-center justify-center mt-4 text-xs text-neutral-500 dark:text-neutral-400">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
          </svg>
          Secure checkout with SSL encryption
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Undo Notification -->
<div class="undo-notification fixed bottom-4 left-4 bg-neutral-900 dark:bg-white text-white dark:text-neutral-900 px-4 py-3 rounded-lg shadow-lg z-50 transform translate-y-full transition-transform duration-300 hidden" id="undo-notification">
  <div class="flex items-center justify-between gap-4">
    <span class="text-sm">Item removed from cart</span>
    <button 
      type="button" 
      class="undo-btn text-primary-400 dark:text-primary-600 text-sm font-medium hover:underline focus:outline-none"
      id="undo-btn"
    >
      Undo
    </button>
  </div>
</div>