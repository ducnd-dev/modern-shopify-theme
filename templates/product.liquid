{% comment %}
  Product Template
  Individual product page template
{% endcomment %}

{% section 'header' %}

<main id="main" class="main-content" role="main">
  <div class="container section-spacing">
    <!-- Breadcrumbs -->
    <nav class="breadcrumbs mb-8" aria-label="Breadcrumb">
      <ol class="flex items-center space-x-2 text-sm text-gray-500">
        <li><a href="/" class="hover:text-gray-700 dark:hover:text-gray-300">Home</a></li>
        <li class="flex items-center">
          <svg class="w-4 h-4 mx-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
          </svg>
          {% if collection %}
            <a href="{{ collection.url }}" class="hover:text-gray-700 dark:hover:text-gray-300">{{ collection.title }}</a>
          {% else %}
            <a href="/collections/all" class="hover:text-gray-700 dark:hover:text-gray-300">Products</a>
          {% endif %}
        </li>
        <li class="flex items-center">
          <svg class="w-4 h-4 mx-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
          </svg>
          <span class="text-gray-900 dark:text-white">{{ product.title }}</span>
        </li>
      </ol>
    </nav>

    <!-- Product Details -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
      <!-- Product Images -->
      <div class="product-images">
        {% if product.media.size > 0 %}
          <div class="main-image mb-4">
            {% assign featured_media = product.selected_or_first_available_variant.featured_media | default: product.featured_media %}
            <img 
              src="{{ featured_media | image_url: width: 800 }}"
              alt="{{ featured_media.alt | escape }}"
              class="w-full h-auto rounded-lg"
              id="product-main-image"
              {% if settings.lazy_loading_enabled %}loading="lazy"{% endif %}
            >
          </div>

          {% if product.media.size > 1 %}
            <div class="thumbnails grid grid-cols-4 gap-2">
              {% for media in product.media limit: 8 %}
                <button 
                  type="button"
                  class="thumbnail border-2 border-transparent hover:border-gray-300 dark:hover:border-gray-600 rounded-lg overflow-hidden transition-colors"
                  data-media-id="{{ media.id }}"
                >
                  {% if media.media_type == 'image' %}
                    <img 
                      src="{{ media | image_url: width: 120 }}"
                      alt="{{ media.alt | escape }}"
                      class="w-full h-full object-cover"
                      {% if settings.lazy_loading_enabled %}loading="lazy"{% endif %}
                    >
                  {% elsif media.media_type == 'video' %}
                    <video class="w-full h-full object-cover" muted>
                      <source src="{{ media | video_url }}" type="video/mp4">
                    </video>
                  {% endif %}
                </button>
              {% endfor %}
            </div>
          {% endif %}
        {% else %}
          <div class="no-image bg-gray-200 dark:bg-gray-700 flex items-center justify-center h-96 rounded-lg">
            <span class="text-gray-500">No image available</span>
          </div>
        {% endif %}
      </div>

      <!-- Product Information -->
      <div class="product-info">
        <!-- Vendor -->
        {% if product.vendor != blank and settings.show_vendor %}
          <p class="text-sm text-gray-500 mb-2">{{ product.vendor }}</p>
        {% endif %}

        <!-- Title -->
        <h1 class="text-3xl font-bold mb-4">{{ product.title }}</h1>

        <!-- Rating -->
        {% if settings.show_product_rating %}
          <div class="rating mb-4" data-rating="4.5">
            <div class="flex items-center gap-2">
              {% for i in (1..5) %}
                <svg class="rating-star w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                </svg>
              {% endfor %}
              <span class="text-sm text-gray-500 ml-2">(24 reviews)</span>
            </div>
          </div>
        {% endif %}

        <!-- Price -->
        <div class="price-container mb-6">
          {% if product.compare_at_price > product.price %}
            <span class="price price--on-sale text-2xl font-bold">
              {{ product.price | money }}
            </span>
            <span class="price--compare-at ml-2">
              {{ product.compare_at_price | money }}
            </span>
            {% assign discount_percentage = product.compare_at_price | minus: product.price | times: 100 | divided_by: product.compare_at_price %}
            <span class="badge badge-sale ml-2">Save {{ discount_percentage }}%</span>
          {% else %}
            <span class="price text-2xl font-bold">
              {{ product.price | money }}
            </span>
          {% endif %}
        </div>

        <!-- Product Form -->
        {% form 'product', product, class: 'product-form' %}
          <!-- Variant Selection -->
          {% unless product.has_only_default_variant %}
            <div class="product-variants space-y-4 mb-6">
              {% for option in product.options_with_values %}
                <div class="variant-option">
                  <label class="block text-sm font-medium mb-2">{{ option.name }}</label>
                  
                  {% if option.name == 'Color' and settings.show_color_swatches %}
                    <div class="color-swatches flex flex-wrap gap-2">
                      {% for value in option.values %}
                        <input 
                          type="radio" 
                          name="options[{{ option.name }}]" 
                          value="{{ value | escape }}" 
                          id="option-{{ option.name }}-{{ forloop.index }}"
                          class="sr-only"
                          {% if option.selected_value == value %}checked{% endif %}
                        >
                        <label 
                          for="option-{{ option.name }}-{{ forloop.index }}"
                          class="color-swatch"
                          style="background-color: {{ value | handle }}"
                          title="{{ value }}"
                        ></label>
                      {% endfor %}
                    </div>
                  {% else %}
                    <select 
                      name="options[{{ option.name }}]" 
                      class="form-select w-full"
                      data-option-index="{{ forloop.index0 }}"
                    >
                      {% for value in option.values %}
                        <option 
                          value="{{ value | escape }}"
                          {% if option.selected_value == value %}selected{% endif %}
                        >
                          {{ value }}
                        </option>
                      {% endfor %}
                    </select>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% endunless %}

          <!-- Quantity and Add to Cart -->
          <div class="product-actions">
            <div class="flex flex-col sm:flex-row gap-4 mb-6">
              <div class="quantity-wrapper">
                <label for="quantity" class="block text-sm font-medium mb-2">Quantity</label>
                <div class="quantity-selector">
                  <button type="button" class="quantity-btn" data-quantity-change="-1">-</button>
                  <input 
                    type="number" 
                    name="quantity" 
                    id="quantity"
                    value="1" 
                    min="1" 
                    class="quantity-input"
                  >
                  <button type="button" class="quantity-btn" data-quantity-change="1">+</button>
                </div>
              </div>

              <div class="add-to-cart-wrapper flex-1">
                <label class="block text-sm font-medium mb-2">&nbsp;</label>
                <button 
                  type="submit" 
                  name="add"
                  class="btn btn-primary w-full"
                  {% unless product.available %}disabled{% endunless %}
                >
                  {% if product.available %}
                    Add to Cart
                  {% else %}
                    Sold Out
                  {% endif %}
                </button>
              </div>
            </div>

            <!-- Buy Now Button -->
            {% if product.available %}
              <button 
                type="submit" 
                name="add"
                class="btn btn-secondary w-full mb-4"
                formaction="/cart"
              >
                Buy Now
              </button>
            {% endif %}
          </div>

          <!-- Hidden inputs -->
          <input type="hidden" name="product-id" value="{{ product.id }}">
          {% unless product.has_only_default_variant %}
            <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
          {% endunless %}
        {% endform %}

        <!-- Product Features -->
        <div class="product-features space-y-3 mb-6">
          <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
            <svg class="w-5 h-5 mr-3 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Free shipping on orders over ${{ settings.free_shipping_threshold | divided_by: 100 }}
          </div>
          <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
            <svg class="w-5 h-5 mr-3 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            30-day return policy
          </div>
          <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
            <svg class="w-5 h-5 mr-3 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Secure checkout
          </div>
        </div>

        <!-- Social Sharing -->
        <div class="social-sharing">
          <h3 class="text-sm font-medium mb-3">Share this product</h3>
          <div class="flex gap-3">
            <a 
              href="https://www.facebook.com/sharer/sharer.php?u={{ shop.url }}{{ product.url }}"
              target="_blank"
              class="text-gray-500 hover:text-blue-600 transition-colors"
              aria-label="Share on Facebook"
            >
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
              </svg>
            </a>
            <a 
              href="https://twitter.com/intent/tweet?url={{ shop.url }}{{ product.url }}&text={{ product.title | escape }}"
              target="_blank"
              class="text-gray-500 hover:text-blue-400 transition-colors"
              aria-label="Share on Twitter"
            >
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
              </svg>
            </a>
            <a 
              href="https://pinterest.com/pin/create/button/?url={{ shop.url }}{{ product.url }}&media={{ product.featured_media | image_url: width: 800 }}&description={{ product.title | escape }}"
              target="_blank"
              class="text-gray-500 hover:text-red-600 transition-colors"
              aria-label="Share on Pinterest"
            >
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12.017 0C5.396 0 .029 5.367.029 11.987c0 5.079 3.158 9.417 7.618 11.174-.105-.949-.199-2.403.041-3.439.219-.937 1.406-5.957 1.406-5.957s-.359-.72-.359-1.781c0-1.663.967-2.911 2.168-2.911 1.024 0 1.518.769 1.518 1.688 0 1.029-.653 2.567-.992 3.992-.285 1.193.6 2.165 1.775 2.165 2.128 0 3.768-2.245 3.768-5.487 0-2.861-2.063-4.869-5.008-4.869-3.41 0-5.409 2.562-5.409 5.199 0 1.033.394 2.143.889 2.741.099.12.112.225.085.345-.09.375-.293 1.199-.334 1.363-.053.225-.172.271-.402.165-1.495-.69-2.433-2.878-2.433-4.646 0-3.776 2.748-7.252 7.92-7.252 4.158 0 7.392 2.967 7.392 6.923 0 4.135-2.607 7.462-6.233 7.462-1.214 0-2.357-.629-2.749-1.378l-.748 2.853c-.271 1.043-1.002 2.35-1.492 3.146C9.57 23.812 10.763 24.009 12.017 24.009c6.624 0 11.99-5.367 11.99-11.988C24.007 5.367 18.641.001 12.017.001z"/>
              </svg>
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Description -->
    {% if product.description != blank %}
      <div class="product-description mt-16">
        <div class="prose prose-lg max-w-none dark:prose-invert">
          {{ product.description }}
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Related Products -->
  {% if recommendations.products.size > 0 %}
    <div class="section-spacing bg-gray-50 dark:bg-gray-900">
      <div class="container">
        <h2 class="text-2xl font-bold text-center mb-12">You might also like</h2>
        <div class="products-grid">
          {% for product in recommendations.products limit: 4 %}
            {% render 'product-card', product: product %}
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}
</main>

{% section 'footer' %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Thumbnail image switching
  const thumbnails = document.querySelectorAll('.thumbnail');
  const mainImage = document.getElementById('product-main-image');
  
  thumbnails.forEach(thumbnail => {
    thumbnail.addEventListener('click', function() {
      const mediaId = this.dataset.mediaId;
      const img = this.querySelector('img');
      if (img && mainImage) {
        mainImage.src = img.src.replace('width=120', 'width=800');
        mainImage.alt = img.alt;
      }
      
      // Update active thumbnail
      thumbnails.forEach(t => t.classList.remove('border-gray-900', 'dark:border-white'));
      this.classList.add('border-gray-900', 'dark:border-white');
    });
  });

  // Quantity controls
  const quantityBtns = document.querySelectorAll('[data-quantity-change]');
  const quantityInput = document.getElementById('quantity');
  
  quantityBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const change = parseInt(this.dataset.quantityChange);
      const currentValue = parseInt(quantityInput.value);
      const newValue = Math.max(1, currentValue + change);
      quantityInput.value = newValue;
    });
  });

  // Variant selection
  const variantSelects = document.querySelectorAll('[data-option-index]');
  const productForm = document.querySelector('.product-form');
  const hiddenVariantInput = document.querySelector('input[name="id"]');
  
  if (variantSelects.length > 0 && hiddenVariantInput) {
    variantSelects.forEach(select => {
      select.addEventListener('change', updateVariant);
    });
  }

  function updateVariant() {
    const options = Array.from(variantSelects).map(select => select.value);
    const variant = findVariantByOptions(options);
    
    if (variant) {
      hiddenVariantInput.value = variant.id;
      updatePrice(variant);
      updateAvailability(variant);
    }
  }

  function findVariantByOptions(options) {
    // This would need to be populated with actual variant data
    // For now, we'll use the first available variant
    return {{ product.variants | json }}.find(variant => {
      return variant.options.every((option, index) => option === options[index]);
    });
  }

  function updatePrice(variant) {
    const priceContainer = document.querySelector('.price-container');
    if (priceContainer && variant) {
      // Update price display logic would go here
    }
  }

  function updateAvailability(variant) {
    const addToCartBtn = document.querySelector('button[name="add"]');
    if (addToCartBtn && variant) {
      if (variant.available) {
        addToCartBtn.disabled = false;
        addToCartBtn.textContent = 'Add to Cart';
      } else {
        addToCartBtn.disabled = true;
        addToCartBtn.textContent = 'Sold Out';
      }
    }
  }
});
</script>